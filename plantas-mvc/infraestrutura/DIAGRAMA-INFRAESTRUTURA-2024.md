# DIAGRAMA DE INFRAESTRUTURA AZURE 2024

## ARQUITETURA COMPLETA - IDENTITY & MONITORING

```
                                    INTERNET
                                       │
                                       ▼
                            ┌─────────────────────┐
                            │   Azure Front Door  │
                            │   (SSL Termination) │
                            └─────────┬───────────┘
                                      │
                      ┌───────────────┼───────────────┐
                      ▼               ▼               ▼
              ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
              │     DEV     │ │   HOMOLOG   │ │  PRODUCAO   │
              │ 10.100.0.0  │ │ 10.200.0.0  │ │ 10.300.0.0  │
              │    /16      │ │    /16      │ │    /16      │
              └─────┬───────┘ └─────┬───────┘ └─────┬───────┘
                    │               │               │
                    ▼               ▼               ▼
```

## AMBIENTE DESENVOLVIMENTO (DEV)

```
┌─────────────────────────────────────────────────────────────────────┐
│                        DEV ENVIRONMENT                             │
│                        (10.100.0.0/16)                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              CONTAINER APPS SUBNET                          │   │
│  │                (10.100.1.0/24)                             │   │
│  │  ┌───────────────────┐    ┌───────────────────┐           │   │
│  │  │   KEYCLOAK APP    │    │ PROMETHEUS STACK  │           │   │
│  │  │                   │    │                   │           │   │
│  │  │ • Identity Mgmt   │    │ • Prometheus      │           │   │
│  │  │ • SSO/OAuth       │    │ • Grafana         │           │   │
│  │  │ • Port: 8080      │    │ • Node Exporter   │           │   │
│  │  │ • Health: /auth   │    │ • OTEL Collector  │           │   │
│  │  │                   │    │ • Port: 9090      │           │   │
│  │  └─────────┬─────────┘    └─────────┬─────────┘           │   │
│  └────────────┼──────────────────────────┼───────────────────┘   │
│               │                          │                       │
│  ┌────────────┼──────────────────────────┼───────────────────┐   │
│  │            ▼         DATABASE         ▼                   │   │
│  │                   (10.100.2.0/24)                        │   │
│  │  ┌─────────────────┐    ┌─────────────────────────────┐  │   │
│  │  │ POSTGRESQL      │    │     SQL SERVER             │  │   │
│  │  │ (Keycloak)      │    │     (Applications)          │  │   │
│  │  │                 │    │                             │  │   │
│  │  │ • Flexible Srv  │    │ • Basic Tier (5 DTU)       │  │   │
│  │  │ • Private Net   │    │ • dev-sqlsrv-min           │  │   │
│  │  │ • Auto Backup   │    │ • TDE Enabled              │  │   │
│  │  │ • Port: 5432    │    │ • Port: 1433               │  │   │
│  │  └─────────────────┘    └─────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              AZURE KEY VAULT                            │   │
│  │                                                         │   │
│  │ • keycloak-db-connection                               │   │
│  │ • keycloak-admin-password                              │   │
│  │ • sql-server-admin-password                            │   │
│  │ • prometheus-config                                     │   │
│  │ • Managed Identity Access                              │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## AMBIENTE HOMOLOGACAO (HOMOLOG)

```
┌─────────────────────────────────────────────────────────────────────┐
│                      HOMOLOG ENVIRONMENT                           │
│                        (10.200.0.0/16)                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │              CONTAINER APPS SUBNET                          │   │
│  │                (10.200.1.0/24)                             │   │
│  │  ┌───────────────────┐    ┌───────────────────┐           │   │
│  │  │   KEYCLOAK APP    │    │ PROMETHEUS STACK  │           │   │
│  │  │                   │    │                   │           │   │
│  │  │ • Production Mode │    │ • Full Monitoring │           │   │
│  │  │ • Load Testing    │    │ • Advanced Alerts │           │   │
│  │  │ • User Federation │    │ • Custom Dashbrd  │           │   │
│  │  │ • Multi-tenant    │    │ • APM Integration │           │   │
│  │  │                   │    │ • 1 Core / 2GB    │           │   │
│  │  └─────────┬─────────┘    └─────────┬─────────┘           │   │
│  └────────────┼──────────────────────────┼───────────────────┘   │
│               │                          │                       │
│  ┌────────────┼──────────────────────────┼───────────────────┐   │
│  │            ▼         DATABASE         ▼                   │   │
│  │                   (10.200.2.0/24)                        │   │
│  │  ┌─────────────────┐    ┌─────────────────────────────┐  │   │
│  │  │ POSTGRESQL      │    │     SQL SERVER             │  │   │
│  │  │ (Keycloak)      │    │     (Applications)          │  │   │
│  │  │                 │    │                             │  │   │
│  │  │ • HA Enabled    │    │ • Standard S0 (10 DTU)     │  │   │
│  │  │ • Read Replica  │    │ • hml-sqlsrv-min           │  │   │
│  │  │ • Point-in-Time │    │ • Geo-Backup              │  │   │
│  │  │ • Private Link  │    │ • Advanced Security        │  │   │
│  │  └─────────────────┘    └─────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │            MONITORING & OBSERVABILITY                   │   │
│  │                                                         │   │
│  │ • Application Insights                                 │   │
│  │ • Log Analytics Workspace                              │   │
│  │ • Custom Metrics & Alerts                              │   │
│  │ • Performance Testing Results                          │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## FLOW DE COMUNICACAO

```
┌─────────────────────────────────────────────────────────────────────┐
│                    COMMUNICATION FLOW                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. CLIENT AUTHENTICATION                                          │
│     ┌────────┐    OAuth 2.0    ┌─────────┐                        │
│     │ CLIENT │ ───────────────▶ │KEYCLOAK │                        │
│     └────────┘                 └─────────┘                        │
│                                      │                             │
│                                      ▼                             │
│                                ┌─────────┐                        │
│                                │AZURE AD │                        │
│                                │(Federat)│                        │
│                                └─────────┘                        │
│                                                                     │
│  2. APPLICATION ACCESS                                             │
│     ┌────────┐   JWT Token    ┌─────────────┐                     │
│     │ CLIENT │ ──────────────▶ │APPLICATION  │                     │
│     └────────┘                └─────────────┘                     │
│                                      │                             │
│                                      ▼                             │
│                                ┌─────────┐                        │
│                                │SQL SRV  │                        │
│                                │DATABASE │                        │
│                                └─────────┘                        │
│                                                                     │
│  3. METRICS COLLECTION                                             │
│     ┌─────────────┐   Metrics   ┌───────────┐                     │
│     │APPLICATION  │ ───────────▶ │PROMETHEUS │                     │
│     └─────────────┘             └───────────┘                     │
│                                      │                             │
│                                      ▼                             │
│                                ┌─────────┐                        │
│                                │GRAFANA  │                        │
│                                │DASHBRD  │                        │
│                                └─────────┘                        │
│                                                                     │
│  4. SECRETS MANAGEMENT                                             │
│     ┌─────────────┐  Managed ID  ┌─────────┐                      │
│     │CONTAINER APP│ ────────────▶ │KEY VAULT│                      │
│     └─────────────┘              └─────────┘                      │
│                                      │                             │
│                                      ▼                             │
│                              (Connection Strings)                  │
│                              (Admin Passwords)                     │
│                              (API Keys)                            │
└─────────────────────────────────────────────────────────────────────┘
```

## SECURITY LAYERS

```
┌─────────────────────────────────────────────────────────────────────┐
│                         SECURITY LAYERS                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  LAYER 1: INTERNET SECURITY                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ • DDoS Protection Standard                                  │   │
│  │ • Azure Front Door WAF                                      │   │
│  │ • SSL/TLS 1.3 Encryption                                   │   │
│  │ • Rate Limiting & Geo-blocking                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  LAYER 2: NETWORK SECURITY                                         │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ • NSG Rules (Deny All + Specific Allow)                    │   │
│  │ • Private Endpoints Only                                   │   │
│  │ • VNet Peering (No Internet Gateway)                       │   │
│  │ • Azure Firewall (Application Rules)                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  LAYER 3: IDENTITY & ACCESS                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ • Azure AD Integration                                      │   │
│  │ • RBAC with Least Privilege                                │   │
│  │ • Managed Identity (No Passwords)                          │   │
│  │ • MFA Enforcement                                          │   │
│  │ • Conditional Access Policies                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  LAYER 4: DATA SECURITY                                            │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ • TDE (Transparent Data Encryption)                        │   │
│  │ • Encryption at Rest (AES-256)                             │   │
│  │ • Encryption in Transit (TLS 1.3)                          │   │
│  │ • Key Vault HSM (FIPS 140-2 Level 2)                       │   │
│  │ • Automated Key Rotation                                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  LAYER 5: MONITORING & COMPLIANCE                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ • Security Center (Threat Detection)                       │   │
│  │ • Sentinel (SIEM)                                          │   │
│  │ • Log Analytics (Audit Trail)                              │   │
│  │ • Policy Compliance (Azure Policy)                         │   │
│  │ • Vulnerability Assessment                                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

## DISASTER RECOVERY

```
┌─────────────────────────────────────────────────────────────────────┐
│                      DISASTER RECOVERY                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  PRIMARY REGION: Brazil South                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    PRODUCTION                               │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │   │
│  │  │   KEYCLOAK  │    │ PROMETHEUS  │    │ DATABASES   │     │   │
│  │  │             │    │             │    │             │     │   │
│  │  │ • Active    │    │ • Active    │    │ • Primary   │     │   │
│  │  │ • Backup    │    │ • Backup    │    │ • Backup    │     │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                │                                    │
│                                ▼ (Continuous Replication)           │
│                                                                     │
│  SECONDARY REGION: Brazil Southeast                                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                   DISASTER RECOVERY                        │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │   │
│  │  │   KEYCLOAK  │    │ PROMETHEUS  │    │ DATABASES   │     │   │
│  │  │             │    │             │    │             │     │   │
│  │  │ • Standby   │    │ • Standby   │    │ • Replica   │     │   │
│  │  │ • Auto-fail │    │ • Auto-fail │    │ • Geo-repli │     │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  RECOVERY METRICS:                                                  │
│  • RTO (Recovery Time Objective): 4 hours                          │
│  • RPO (Recovery Point Objective): 1 hour                          │
│  • Automated failover triggers                                     │
│  • Manual failover procedures                                      │
│  • Monthly DR testing                                              │
└─────────────────────────────────────────────────────────────────────┘
```

## COST OPTIMIZATION

```
┌─────────────────────────────────────────────────────────────────────┐
│                      COST OPTIMIZATION                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ENVIRONMENT COST BREAKDOWN:                                       │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                         DEV                                 │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │   │
│  │  │ Container Apps  │  │   SQL Basic     │  │   Storage   │ │   │
│  │  │    R$ 50/mes    │  │   R$ 100/mes    │  │  R$ 50/mes  │ │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────┘ │   │
│  │                      TOTAL: R$ 200/mes                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                       HOMOLOG                               │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │   │
│  │  │ Container Apps  │  │  SQL Standard   │  │   Storage   │ │   │
│  │  │   R$ 200/mes    │  │   R$ 400/mes    │  │ R$ 100/mes  │ │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────┘ │   │
│  │  ┌─────────────────┐                                      │   │
│  │  │  Monitoring     │                                      │   │
│  │  │   R$ 100/mes    │                                      │   │
│  │  └─────────────────┘                                      │   │
│  │                      TOTAL: R$ 800/mes                     │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      PRODUCAO                               │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │   │
│  │  │ Container Apps  │  │  SQL Premium    │  │Premium Stor │ │   │
│  │  │   R$ 800/mes    │  │  R$ 1500/mes    │  │ R$ 300/mes  │ │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────┘ │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                 │   │
│  │  │   Monitoring    │  │  Backup & DR    │                 │   │
│  │  │   R$ 200/mes    │  │   R$ 200/mes    │                 │   │
│  │  └─────────────────┘  └─────────────────┘                 │   │
│  │                      TOTAL: R$ 3000/mes                    │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

**ARQUITETURA ENTERPRISE-READY COM IDENTITY MANAGEMENT E OBSERVABILIDADE COMPLETA**
